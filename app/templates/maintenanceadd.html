{% extends "base.html" %}

{% block content %}

<div class="p-4 mx-auto max-w-2xl sm:p-6 lg:p-8">
    <!-- Header -->
    <div class="pb-6 mb-6">
        <a href="{% url 'motodetails' moto_id=motorcycle.id %}" class="text-sm text-orange-400 hover:underline">&larr; Volver al Historial</a>
        <h2 class="mt-2 text-3xl font-bold">
            {% if mode == 'multiple' %}
                Mantenimiento M칰ltiple
            {% else %}
                Registrar Nuevo Mantenimiento
            {% endif %}
        </h2>
        <p class="text-gray-400">A침ade los detalles del servicio realizado a tu <span class="font-bold text-orange-400">{{ motorcycle.make }} {{ motorcycle.model }}</span>.</p>
    </div>

    <!-- Add Maintenance Form -->
    <form action="{% url 'maintenance_add' moto_id=motorcycle.id %}?mode={{ mode }}" method="POST" class="p-6 space-y-6 bg-gray-800 rounded-xl border border-gray-700" id="maintenance-form">
        {% csrf_token %}
        <!-- Form Fields Grid -->
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
            
            <!-- SELECCI칍N DE SERVICIOS (L칩gica H칤brida) -->
            <div class="sm:col-span-2">
                <label class="block text-sm font-medium text-gray-300 mb-3">Servicios Realizados</label>
                
                {% if mode == 'multiple' %}
                    <!-- MODO M칔LTIPLE: TARJETAS INTERACTIVAS (GRID) -->
                    <!-- CAMBIO: Se elimin칩 max-h-80, overflow-y-auto y custom-scrollbar para que se expanda completo -->
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        {% for opcion in service_options %}
                        <div class="relative">
                            <input class="sr-only peer" type="checkbox" name="service_types" id="service_{{ opcion.id }}" value="{{ opcion.id }}">
                            <label for="service_{{ opcion.id }}" 
                                   class="flex flex-col items-center justify-center p-3 text-center h-full min-h-[80px] text-gray-400 bg-gray-900/50 border border-gray-600 rounded-xl cursor-pointer hover:bg-gray-700 transition-all duration-200
                                          peer-checked:border-orange-500 peer-checked:text-white peer-checked:bg-orange-500/10 peer-checked:shadow-[0_0_10px_rgba(249,115,22,0.3)]
                                          peer-checked:[&>svg]:block peer-checked:[&>.default-icon]:hidden">
                                <!-- Check Icon (Solo visible al seleccionar) -->
                                <svg class="w-5 h-5 mb-1 text-orange-500 hidden animate-bounce-short" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                <!-- Default Icon (Opcional, punto simple si no est치 seleccionado) -->
                                <div class="w-2 h-2 rounded-full bg-gray-600 mb-2 default-icon"></div>
                                
                                <span class="text-xs sm:text-sm font-medium leading-tight">{{ opcion.label }}</span>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    <p class="mt-3 text-xs text-orange-400 flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Toca las tarjetas para seleccionar los servicios.
                    </p>
                {% else %}
                    <!-- MODO SINGLE: SELECT CL츼SICO (BLOQUEABLE) -->
                    <select id="service-type" name="service-type" required 
                        class="block w-full px-3 py-2 mt-1 text-white bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm 
                        {% if componente_preseleccionado %} opacity-60 cursor-not-allowed bg-gray-800 {% endif %}"
                        {% if componente_preseleccionado %} disabled {% endif %}>
                        
                        <option value="" disabled {% if not componente_preseleccionado %}selected{% endif %}>Selecciona un servicio...</option>
                        {% for opcion in service_options %}
                            <option value="{{ opcion.id }}" {% if opcion.id == componente_preseleccionado %}selected{% endif %}>{{ opcion.label }}</option>
                        {% endfor %}
                    </select>

                    <!-- LOGICA DE BLOQUEO: Si est치 disabled, el select no env칤a valor. Usamos un hidden. -->
                    {% if componente_preseleccionado %}
                        <input type="hidden" name="service-type" value="{{ componente_preseleccionado }}">
                        <p class="mt-1 text-xs text-orange-400 flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                            Componente fijado. Para cambiar, usa el modo m칰ltiple.
                        </p>
                    {% else %}
                        <p class="mt-1 text-xs text-gray-500">Opciones personalizadas para tu modelo.</p>
                    {% endif %}
                {% endif %}
            </div>

            <!-- Fecha del Servicio (PRE-LLENADA CON HOY) -->
            <div>
                <label for="date" class="block text-sm font-medium text-gray-300">Fecha del Servicio</label>
                <input type="date" 
                       name="date" 
                       id="date" 
                       value="{% now 'Y-m-d' %}" 
                       required 
                       class="block w-full px-3 py-2 mt-1 text-white bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm" 
                       style="color-scheme: dark;">
            </div>

            <!-- Kilometraje en el Servicio (VALIDADO Y PRE-LLENADO) -->
            <div>
                <label for="mileage-at-service" class="block text-sm font-medium text-gray-300">Kilometraje en el Servicio</label>
                <input type="number" 
                       name="mileage-at-service" 
                       id="mileage-at-service" 
                       min="{{ motorcycle.mileage }}" 
                       value="{{ motorcycle.mileage }}" 
                       required 
                       class="block w-full px-3 py-2 mt-1 text-white bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                <p class="mt-1 text-xs text-gray-500">M칤nimo actual: {{ motorcycle.mileage }} km</p>
            </div>

            <!-- FEEDBACK PARA LA IA -->
            <div class="sm:col-span-2 p-4 bg-gray-900/50 rounded-lg border border-gray-600 border-dashed">
                <label class="block text-sm font-medium text-orange-400 mb-2">
                    游뱄 Ayuda a la IA: 쮼n qu칠 estado estaban las piezas?
                </label>
                <div class="grid grid-cols-2 gap-3 sm:grid-cols-4">
                    <!-- Opci칩n 1: Como Nuevo -->
                    <div class="relative">
                        <input class="sr-only peer" type="radio" name="condicion_reportada" id="cond_nuevo" value="como_nuevo">
                        <label class="flex flex-col items-center justify-center p-2 text-gray-400 bg-gray-800 border border-gray-600 rounded-lg cursor-pointer peer-checked:border-green-500 peer-checked:text-green-500 hover:bg-gray-700 transition-all" for="cond_nuevo">
                            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span class="text-xs font-medium">Como Nuevo</span>
                        </label>
                    </div>
                    <!-- Opci칩n 2: Normal -->
                    <div class="relative">
                        <input class="sr-only peer" type="radio" name="condicion_reportada" id="cond_normal" value="desgaste_normal" checked>
                        <label class="flex flex-col items-center justify-center p-2 text-gray-400 bg-gray-800 border border-gray-600 rounded-lg cursor-pointer peer-checked:border-blue-500 peer-checked:text-blue-500 hover:bg-gray-700 transition-all" for="cond_normal">
                            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            <span class="text-xs font-medium">Normal</span>
                        </label>
                    </div>
                    <!-- Opci칩n 3: Muy Desgastado -->
                    <div class="relative">
                        <input class="sr-only peer" type="radio" name="condicion_reportada" id="cond_desgastado" value="muy_desgastado">
                        <label class="flex flex-col items-center justify-center p-2 text-gray-400 bg-gray-800 border border-gray-600 rounded-lg cursor-pointer peer-checked:border-orange-500 peer-checked:text-orange-500 hover:bg-gray-700 transition-all" for="cond_desgastado">
                            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            <span class="text-xs font-medium">Muy Usado</span>
                        </label>
                    </div>
                    <!-- Opci칩n 4: Fallo Cr칤tico -->
                    <div class="relative">
                        <input class="sr-only peer" type="radio" name="condicion_reportada" id="cond_fallo" value="fallo_critico">
                        <label class="flex flex-col items-center justify-center p-2 text-gray-400 bg-gray-800 border border-gray-600 rounded-lg cursor-pointer peer-checked:border-red-500 peer-checked:text-red-500 hover:bg-gray-700 transition-all" for="cond_fallo">
                            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
                            <span class="text-xs font-medium">Fallo/Roto</span>
                        </label>
                    </div>
                </div>
                {% if mode == 'multiple' %}
                <p class="mt-2 text-[10px] text-gray-500 text-center">* Se aplicar치 esta condici칩n a todos los items seleccionados.</p>
                {% endif %}
            </div>

            <!-- Costo (Opcional) -->
            <div class="sm:col-span-2">
                <label for="cost" class="block text-sm font-medium text-gray-300">Costo Total (Opcional)</label>
                <div class="relative mt-1 rounded-md shadow-sm">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none">
                        <span class="text-gray-500 sm:text-sm">C$</span>
                    </div>
                    <input type="number" name="cost" id="cost" step="0.01" class="block w-full py-2 pl-7 pr-12 text-white bg-gray-700 border-gray-600 rounded-md focus:ring-orange-500 focus:border-orange-500" placeholder="0.00">
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <span class="text-gray-500 sm:text-sm">NIO</span>
                    </div>
                </div>
                {% if mode == 'multiple' %}
                <p class="mt-1 text-xs text-gray-500">El costo se dividir치 equitativamente entre los servicios.</p>
                {% endif %}
            </div>

            <!-- Notas Adicionales -->
            <div class="sm:col-span-2">
                 <label for="notes" class="block text-sm font-medium text-gray-300">Notas Adicionales (Opcional)</label>
                 <textarea id="notes" name="notes" rows="4" class="block w-full px-3 py-2 mt-1 text-white bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="Detalles de la marca, taller, etc."></textarea>
            </div>
        </div>

        <!-- Botones de Acci칩n -->
        <div class="pt-5 border-t border-gray-700">
            <div class="flex justify-end gap-3">
                <a href="{% url 'motodetails' moto_id=motorcycle.id %}" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 border border-transparent rounded-md shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-gray-500 transition-colors">
                    Cancelar
                </a>
                <button type="button" id="open-reminder-modal-button" class="inline-flex justify-center px-4 py-2 text-sm font-bold text-gray-900 bg-orange-400 border border-transparent rounded-md shadow-sm hover:bg-orange-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-orange-500 transition-colors">
                    Continuar
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Reminder Modal -->
<div id="reminder-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-75 backdrop-blur-sm">
    <div class="w-full max-w-lg p-6 bg-gray-800 rounded-xl shadow-2xl border border-gray-700">
        <div class="flex items-center justify-between pb-3 border-b border-gray-700">
            <h3 class="text-xl font-bold text-white">Programar Recordatorio</h3>
            <button id="close-modal-button" class="p-1 text-gray-400 rounded-full hover:bg-gray-700 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <div class="mt-4">
            <p class="text-sm text-gray-400">쯈uieres que te avisemos para el pr칩ximo servicio?</p>

            <div class="mt-4 space-y-4">
                 <div>
                    <label for="reminder-type" class="block text-sm font-medium text-gray-300">Tipo de Recordatorio</label>
                    <select id="reminder-type" name="reminder-type" form="maintenance-form" class="block w-full px-3 py-2 mt-1 text-white bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                        <option value="none">No crear recordatorio</option>
                        <option value="distance">Por Distancia (km)</option>
                        <option value="date">Por Fecha</option>
                    </select>
                </div>

                <div id="distance-field" class="hidden">
                    <label for="next-service-mileage" class="block text-sm font-medium text-gray-300">Avisar dentro de (km)</label>
                    <input type="number" name="next-service-mileage" id="next-service-mileage" form="maintenance-form" placeholder="e.g., 5000" class="block w-full px-3 py-2 mt-1 text-white bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                </div>

                <div id="date-field" class="hidden">
                      <label for="next-service-date" class="block text-sm font-medium text-gray-300">Fecha del pr칩ximo servicio</label>
                      <input type="date" name="next-service-date" id="next-service-date" form="maintenance-form" class="block w-full px-3 py-2 mt-1 text-white bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm" style="color-scheme: dark;">
                </div>
            </div>
        </div>

        <div class="flex justify-end pt-6 mt-6 border-t border-gray-700 space-x-3">
             <button type="button" id="save-without-reminder-button" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 border border-transparent rounded-md shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-gray-500">
                Solo Guardar
            </button>
            <button type="submit" form="maintenance-form" id="save-with-reminder-button" class="inline-flex justify-center px-4 py-2 text-sm font-bold text-gray-900 bg-orange-400 border border-transparent rounded-md shadow-sm hover:bg-orange-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-orange-500">
                Guardar y Recordar
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const openModalButton = document.getElementById('open-reminder-modal-button');
        const modal = document.getElementById('reminder-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const saveWithoutReminderButton = document.getElementById('save-without-reminder-button');
        const maintenanceForm = document.getElementById('maintenance-form');

        const reminderTypeSelect = document.getElementById('reminder-type');
        const distanceField = document.getElementById('distance-field');
        const dateField = document.getElementById('date-field');

        // Open modal with validation
        openModalButton.addEventListener('click', function(event) {
            event.preventDefault();
            
            // Check HTML5 validity first
            if(!maintenanceForm.checkValidity()){
                maintenanceForm.reportValidity();
                return;
            }

            // Custom Check for Multiple Mode
            {% if mode == 'multiple' %}
            const checkboxes = document.querySelectorAll('input[name="service_types"]:checked');
            if (checkboxes.length === 0) {
                alert("Por favor selecciona al menos un servicio.");
                return;
            }
            {% endif %}

            modal.classList.remove('hidden');
        });

        // Close modal with X button
        closeModalButton.addEventListener('click', function() {
            modal.classList.add('hidden');
        });

        // Handle reminder type change
        reminderTypeSelect.addEventListener('change', function() {
            distanceField.classList.toggle('hidden', this.value !== 'distance');
            dateField.classList.toggle('hidden', this.value !== 'date');
        });
        
        // Logic for "Save without Reminder" button
        saveWithoutReminderButton.addEventListener('click', function() {
            // Set reminder type to none explicitly just in case
            reminderTypeSelect.value = 'none';
            maintenanceForm.submit();
        });
        
        // Close modal if clicking outside of it
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.classList.add('hidden');
            }
        });
    });
</script>

<style>
    /* Animaci칩n personalizada para el 칤cono de check */
    @keyframes bounce-short {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-3px); }
    }
    .animate-bounce-short {
        animation: bounce-short 0.3s ease-in-out;
    }
</style>

{% endblock %}