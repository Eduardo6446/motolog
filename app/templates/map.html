{% extends "base.html" %}

{% block content %}

<div class="p-4 mx-auto max-w-7xl sm:p-6 lg:p-8 h-full flex flex-col">
    <!-- Header -->
    <div class="pb-6 mb-6 border-b border-gray-700 flex justify-between items-center">
        <div>
            <h2 class="text-3xl font-bold text-white">Mapa y Rutas</h2>
            <p class="text-gray-400">Explora talleres y registra tus aventuras.</p>
        </div>
        
        <!-- Bot√≥n Escritorio -->
        <button id="btn-add-trip-header" class="hidden sm:flex px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white font-bold rounded-lg shadow-lg transition-all text-sm items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            Nueva Ruta
        </button>
    </div>
    
    <!-- Grid Principal -->
    <div class="grid grid-cols-1 gap-8 lg:grid-cols-3 flex-1 h-full min-h-[600px]">
        
        <!-- COLUMNA IZQUIERDA: MAPA INTERACTIVO (2/3) -->
        <div class="lg:col-span-2 flex flex-col h-full">
            <div class="relative w-full h-[60vh] lg:h-full overflow-hidden bg-gray-800 rounded-xl border border-gray-700 shadow-xl group">
                <!-- Google Maps Embed Din√°mico -->
                <!-- ID agregado para controlarlo con JS -->
                <iframe 
                    id="map-frame"
                    src="https://maps.google.com/maps?q=Managua,Nicaragua&t=&z=13&ie=UTF8&iwloc=&output=embed" 
                    width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" 
                    class="absolute inset-0 w-full h-full filter grayscale-[20%] group-hover:grayscale-0 transition-all duration-500">
                </iframe>
                
                <!-- Overlay de carga (Opcional, para feedback visual al cambiar) -->
                <div id="map-loader" class="absolute inset-0 bg-gray-900 flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"></div>
                </div>
                
                <!-- Buscador flotante -->
                <div class="absolute top-4 left-4 right-4 sm:right-auto sm:w-80">
                    <div class="relative">
                        <input type="text" id="workshop-search" onkeyup="filterWorkshops()" 
                               placeholder="Buscar taller o direcci√≥n..." 
                               class="w-full pl-10 pr-4 py-3 text-white bg-gray-900/90 backdrop-blur-sm border border-gray-600 rounded-lg shadow-lg focus:ring-2 focus:ring-orange-500 focus:outline-none transition-all placeholder-gray-400">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- COLUMNA DERECHA: PESTA√ëAS Y CONTENIDO (1/3) -->
        <div class="lg:col-span-1 flex flex-col h-full bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
            
            <!-- TABS -->
            <div class="flex border-b border-gray-700">
                <button onclick="switchTab('workshops')" id="tab-workshops" class="flex-1 py-4 text-center font-bold text-orange-400 border-b-2 border-orange-500 bg-gray-700/30 transition-all">
                    üõ†Ô∏è Talleres
                </button>
                <button onclick="switchTab('trips')" id="tab-trips" class="flex-1 py-4 text-center font-bold text-gray-400 hover:text-white transition-all">
                    üó∫Ô∏è Mis Viajes
                </button>
            </div>

            <!-- CONTENIDO TAB 1: TALLERES -->
            <div id="content-workshops" class="p-4 overflow-y-auto flex-1 space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Cercanos a ti</h3>
                    
                    <!-- Filtro Simple -->
                    <div class="relative">
                        <button onclick="document.getElementById('filter-options').classList.toggle('hidden')" class="text-xs text-orange-400 hover:text-orange-300 flex items-center gap-1 font-bold">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                            Filtrar
                        </button>
                        <div id="filter-options" class="hidden absolute right-0 mt-2 w-32 bg-gray-700 rounded-lg shadow-xl z-20 border border-gray-600">
                            <a href="#" onclick="filterStatus('all')" class="block px-4 py-2 text-xs text-white hover:bg-gray-600 rounded-t-lg">Todos</a>
                            <a href="#" onclick="filterStatus('open')" class="block px-4 py-2 text-xs text-white hover:bg-gray-600 rounded-b-lg">Solo Abiertos</a>
                        </div>
                    </div>
                </div>
                
                <!-- Workshop Card 1 -->
                <div class="workshop-card p-4 bg-gray-700/40 rounded-xl border border-gray-600 hover:border-orange-500/50 transition-colors cursor-pointer group"
                     data-name="Taller El R√°pido" data-address="Rotonda El Periodista, Managua" data-status="open">
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-white group-hover:text-orange-400">Taller El R√°pido</h4>
                        <span class="px-2 py-0.5 text-xs font-bold text-green-300 bg-green-500/20 rounded-full border border-green-500/30">Abierto</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Rotonda El Periodista, 2c sur.</p>
                    <div class="mt-3 flex justify-between items-center pt-3 border-t border-gray-600/50">
                        <span class="text-xs text-gray-300 font-bold flex items-center gap-1">‚≠ê 4.5 <span class="font-normal text-gray-500">‚Ä¢ 1.2 km</span></span>
                        
                        <!-- BOT√ìN: VER EN MAPA -->
                        <button onclick="locateOnMap('Rotonda El Periodista, Managua')" class="px-3 py-1.5 text-xs font-bold text-gray-900 bg-orange-400 rounded-lg hover:bg-orange-500 transition-colors flex items-center gap-1 shadow-md hover:shadow-orange-500/20">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            Ver en Mapa
                        </button>
                    </div>
                </div>

                <!-- Workshop Card 2 -->
                <div class="workshop-card p-4 bg-gray-700/40 rounded-xl border border-gray-600 hover:border-orange-500/50 transition-colors cursor-pointer group"
                     data-name="MotoServicios Express" data-address="Villa Fontana, Managua" data-status="open">
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-white group-hover:text-orange-400">MotoServicios Express</h4>
                        <span class="px-2 py-0.5 text-xs font-bold text-green-300 bg-green-500/20 rounded-full border border-green-500/30">Abierto</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Villa Fontana, 1c lago.</p>
                    <div class="mt-3 flex justify-between items-center pt-3 border-t border-gray-600/50">
                        <span class="text-xs text-gray-300 font-bold flex items-center gap-1">‚≠ê 4.8 <span class="font-normal text-gray-500">‚Ä¢ 2.5 km</span></span>
                        
                        <button onclick="locateOnMap('Villa Fontana, Managua')" class="px-3 py-1.5 text-xs font-bold text-gray-900 bg-orange-400 rounded-lg hover:bg-orange-500 transition-colors flex items-center gap-1 shadow-md hover:shadow-orange-500/20">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            Ver en Mapa
                        </button>
                    </div>
                </div>

                 <!-- Workshop Card 3 -->
                <div class="workshop-card p-4 bg-gray-700/40 rounded-xl border border-gray-600 opacity-75"
                     data-name="Central de Repuestos" data-address="Mercado Roberto Huembes, Managua" data-status="closed">
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-white">Central de Repuestos</h4>
                        <span class="px-2 py-0.5 text-xs font-bold text-red-300 bg-red-500/20 rounded-full border border-red-500/30">Cerrado</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Mercado Huembes.</p>
                    <div class="mt-3 flex justify-between items-center pt-3 border-t border-gray-600/50">
                        <span class="text-xs text-gray-500">4.1 km</span>
                        <button disabled class="px-3 py-1.5 text-xs font-bold text-gray-500 bg-gray-800 rounded-lg cursor-not-allowed">
                            Cerrado
                        </button>
                    </div>
                </div>
            </div>

            <!-- CONTENIDO TAB 2: VIAJES -->
            <div id="content-trips" class="hidden p-4 overflow-y-auto flex-1 space-y-6">
                
                {% if main_moto %}
                    <div class="flex justify-between items-center text-xs text-gray-400 bg-gray-900/50 p-2 rounded-lg">
                        <span>Moto: <b class="text-white">{{ main_moto.nickname }}</b></span>
                        <span>Total: <b class="text-orange-400">{{ total_km_trips }} km</b></span>
                    </div>

                    {% if trips %}
                    <div class="relative border-l-2 border-gray-600 ml-2 space-y-6">
                        {% for trip in trips %}
                        <div class="relative pl-6">
                            <div class="absolute -left-[9px] top-1 w-4 h-4 rounded-full border-2 border-gray-800
                                {% if trip.terrain == 'city' %} bg-blue-500
                                {% elif trip.terrain == 'highway' %} bg-purple-500
                                {% else %} bg-orange-500 {% endif %}">
                            </div>
                            
                            <div class="p-3 bg-gray-700/30 rounded-lg border border-gray-600">
                                <div class="flex justify-between items-start">
                                    <h4 class="text-sm font-bold text-white">{{ trip.title }}</h4>
                                    <span class="text-[10px] text-gray-400">{{ trip.date|date:"d/m/y" }}</span>
                                </div>
                                <div class="flex gap-3 mt-2 text-xs text-gray-300">
                                    <span class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> {{ trip.distance_km }} km</span>
                                    <span class="opacity-70">{{ trip.get_terrain_display }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                        <div class="text-center py-10 text-gray-500">
                            <p>No hay viajes registrados.</p>
                            <button id="btn-add-trip-empty" class="mt-2 text-orange-400 hover:underline text-sm">Registrar el primero</button>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-10 text-gray-500">
                        <p>Selecciona una moto para ver sus viajes.</p>
                    </div>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<!-- BOT√ìN FLOTANTE (FAB) M√ìVIL -->
<button id="btn-add-trip-fab" class="hidden fixed bottom-24 right-6 z-40 p-4 text-gray-900 bg-orange-500 rounded-full shadow-2xl sm:hidden hover:bg-orange-600 transition-transform hover:scale-110 focus:outline-none border-2 border-orange-400">
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
</button>

<!-- MODAL NUEVO VIAJE -->
<div id="trip-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-80 backdrop-blur-sm">
    <div class="w-full max-w-lg p-6 bg-gray-800 rounded-2xl shadow-2xl border border-gray-700">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-white">Registrar Ruta</h3>
            <button id="close-trip-modal" class="text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        </div>

        <form action="{% url 'map' %}" method="POST" class="space-y-4">
            {% csrf_token %}
            
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">T√≠tulo</label>
                <input type="text" name="title" required placeholder="Ej: Vuelta a la Laguna" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm focus:ring-1 focus:ring-orange-500 focus:outline-none">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Fecha</label>
                    <input type="date" name="date" required value="{% now 'Y-m-d' %}" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm" style="color-scheme: dark;">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Distancia (km)</label>
                    <input type="number" name="distance" required placeholder="120" min="1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm focus:ring-1 focus:ring-orange-500 focus:outline-none">
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Tipo de Terreno</label>
                <select name="terrain" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none">
                    <option value="mixed" selected>Mixto</option>
                    <option value="city">Ciudad</option>
                    <option value="highway">Carretera</option>
                    <option value="offroad">Off-Road</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Notas</label>
                <textarea name="notes" rows="2" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none"></textarea>
            </div>

            <div class="flex items-center gap-2 pt-2">
                <input type="checkbox" name="update_odometer" id="update_odometer" class="w-4 h-4 text-orange-500 bg-gray-700 border-gray-600 rounded focus:ring-orange-500">
                <label for="update_odometer" class="text-xs text-gray-300 cursor-pointer">Sumar al od√≥metro de la moto</label>
            </div>

            <div class="pt-4 flex justify-end gap-3">
                <button type="button" id="cancel-trip-modal" class="px-4 py-2 text-gray-300 hover:text-white bg-gray-700 rounded-lg">Cancelar</button>
                <button type="submit" class="px-6 py-2 bg-orange-500 hover:bg-orange-600 text-white font-bold rounded-lg shadow-lg">Guardar Viaje</button>
            </div>
        </form>
    </div>
</div>

<script>
    // --- NUEVO: FUNCI√ìN PARA LOCALIZAR EN EL MAPA ---
    function locateOnMap(address) {
        const mapFrame = document.getElementById('map-frame');
        const loader = document.getElementById('map-loader');
        
        // Efecto visual de carga
        if (loader) {
            loader.classList.remove('hidden');
            loader.classList.remove('opacity-0');
        }

        // Construir URL de Embed sin API Key (M√©todo compatible con b√∫squedas)
        // Usamos encodeURIComponent para que los espacios y tildes no rompan la URL
        const newSrc = `https://maps.google.com/maps?q=${encodeURIComponent(address)}&t=&z=15&ie=UTF8&iwloc=&output=embed`;
        
        mapFrame.src = newSrc;

        // Ocultar loader cuando cargue (aprox)
        setTimeout(() => {
            if (loader) {
                loader.classList.add('opacity-0');
                setTimeout(() => loader.classList.add('hidden'), 300);
            }
        }, 1500);
    }

    // --- L√ìGICA DE B√öSQUEDA Y FILTRADO ---
    function filterWorkshops() {
        const input = document.getElementById('workshop-search');
        const filter = input.value.toLowerCase();
        const cards = document.querySelectorAll('.workshop-card');

        cards.forEach(card => {
            const name = card.getAttribute('data-name').toLowerCase();
            const address = card.getAttribute('data-address').toLowerCase();
            
            if (name.includes(filter) || address.includes(filter)) {
                card.classList.remove('hidden');
            } else {
                card.classList.add('hidden');
            }
        });
    }

    function filterStatus(status) {
        const cards = document.querySelectorAll('.workshop-card');
        document.getElementById('filter-options').classList.add('hidden'); // Cerrar dropdown
        
        cards.forEach(card => {
            const cardStatus = card.getAttribute('data-status');
            if (status === 'all' || cardStatus === status) {
                card.classList.remove('hidden');
            } else {
                card.classList.add('hidden');
            }
        });
    }

    // --- L√≥gica de Pesta√±as ---
    function switchTab(tab) {
        const contentW = document.getElementById('content-workshops');
        const contentT = document.getElementById('content-trips');
        const btnW = document.getElementById('tab-workshops');
        const btnT = document.getElementById('tab-trips');
        
        const btnAdd = document.getElementById('btn-add-trip-header');
        const btnFab = document.getElementById('btn-add-trip-fab');

        if (tab === 'workshops') {
            contentW.classList.remove('hidden');
            contentT.classList.add('hidden');
            
            btnW.classList.add('text-orange-400', 'border-b-2', 'border-orange-500', 'bg-gray-700/30');
            btnW.classList.remove('text-gray-400');
            btnT.classList.remove('text-orange-400', 'border-b-2', 'border-orange-500', 'bg-gray-700/30');
            btnT.classList.add('text-gray-400');
            
            btnAdd.classList.remove('sm:flex'); 
            btnAdd.classList.add('hidden');     
            btnFab.classList.add('hidden'); 

        } else {
            contentW.classList.add('hidden');
            contentT.classList.remove('hidden');
            
            btnT.classList.add('text-orange-400', 'border-b-2', 'border-orange-500', 'bg-gray-700/30');
            btnT.classList.remove('text-gray-400');
            btnW.classList.remove('text-orange-400', 'border-b-2', 'border-orange-500', 'bg-gray-700/30');
            btnW.classList.add('text-gray-400');
            
            btnAdd.classList.add('sm:flex'); 
            btnFab.classList.remove('hidden'); 
        }
    }

    // --- L√≥gica Modal ---
    const modal = document.getElementById('trip-modal');
    const openBtn1 = document.getElementById('btn-add-trip-header');
    const openBtn2 = document.getElementById('btn-add-trip-empty');
    const openBtnFab = document.getElementById('btn-add-trip-fab');
    const closeBtn = document.getElementById('close-trip-modal');
    const cancelBtn = document.getElementById('cancel-trip-modal');

    const openModal = () => modal.classList.remove('hidden');
    const closeModal = () => modal.classList.add('hidden');

    if(openBtn1) openBtn1.addEventListener('click', openModal);
    if(openBtn2) openBtn2.addEventListener('click', openModal);
    if(openBtnFab) openBtnFab.addEventListener('click', openModal);
    if(closeBtn) closeBtn.addEventListener('click', closeModal);
    if(cancelBtn) cancelBtn.addEventListener('click', closeModal);
    
    modal.addEventListener('click', (e) => {
        if(e.target === modal) closeModal();
    });
</script>

{% endblock %}