{% extends "base.html" %}

{% block content %}

<div class="p-4 mx-auto max-w-7xl sm:p-6 lg:p-8 h-full flex flex-col">
    <!-- Header -->
    <div class="pb-6 mb-6 border-b border-gray-700 flex justify-between items-center">
        <div>
            <h2 class="text-3xl font-bold text-white">Mapa y Rutas</h2>
            <p class="text-gray-400">Explora talleres y registra tus aventuras.</p>
        </div>
        
        <!-- Bot√≥n Escritorio:
             Siempre tiene 'hidden' base para no salir en m√≥vil.
             JS le agregar√° 'sm:flex' solo cuando sea necesario en escritorio. 
        -->
        <button id="btn-add-trip-header" class="hidden px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white font-bold rounded-lg shadow-lg transition-all text-sm items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            Nueva Ruta
        </button>
    </div>
    
    <!-- Grid Principal -->
    <div class="grid grid-cols-1 gap-8 lg:grid-cols-3 flex-1 h-full min-h-[600px]">
        
        <!-- COLUMNA IZQUIERDA: MAPA (2/3) -->
        <div class="lg:col-span-2 flex flex-col h-full">
            <div class="relative w-full h-[60vh] lg:h-full overflow-hidden bg-gray-800 rounded-xl border border-gray-700 shadow-xl">
                <!-- Google Maps Embed -->
                <iframe 
                    src="https://www.google.com/maps/embed?pb=!1m14!1m12!1m3!1d62402.13524674721!2d-86.25754593417967!3d12.136279641753177!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e0!3m2!1ses!2sni!4v1700000000000!5m2!1ses!2sni" 
                    width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" 
                    class="absolute inset-0 w-full h-full filter grayscale-[20%] hover:grayscale-0 transition-all duration-500">
                </iframe>
                
                <!-- Buscador flotante -->
                <div class="absolute top-4 left-4 right-4 sm:right-auto sm:w-80">
                    <input type="text" placeholder="Buscar en el mapa..." class="w-full pl-4 pr-4 py-3 text-white bg-gray-900/90 backdrop-blur-sm border border-gray-600 rounded-lg shadow-lg focus:ring-2 focus:ring-orange-500 focus:outline-none">
                </div>
            </div>
        </div>

        <!-- COLUMNA DERECHA: PESTA√ëAS Y CONTENIDO (1/3) -->
        <div class="lg:col-span-1 flex flex-col h-full bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
            
            <!-- TABS -->
            <div class="flex border-b border-gray-700">
                <button onclick="switchTab('workshops')" id="tab-workshops" class="flex-1 py-4 text-center font-bold text-orange-400 border-b-2 border-orange-500 bg-gray-700/30 transition-all">
                    üõ†Ô∏è Talleres
                </button>
                <button onclick="switchTab('trips')" id="tab-trips" class="flex-1 py-4 text-center font-bold text-gray-400 hover:text-white transition-all">
                    üó∫Ô∏è Mis Viajes
                </button>
            </div>

            <!-- CONTENIDO TAB 1: TALLERES -->
            <div id="content-workshops" class="p-4 overflow-y-auto flex-1 space-y-4">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">Cercanos a ti</h3>
                
                <!-- Card Taller 1 -->
                <div class="p-4 bg-gray-700/40 rounded-xl border border-gray-600 hover:border-orange-500/50 transition-colors cursor-pointer group">
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-white group-hover:text-orange-400">Taller El R√°pido</h4>
                        <span class="text-xs bg-green-500/20 text-green-300 px-2 py-0.5 rounded-full">Abierto</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Rotonda El Periodista, 2c sur.</p>
                    <div class="mt-3 flex justify-between items-center">
                        <span class="text-xs text-gray-300 font-bold">‚≠ê 4.5</span>
                        <span class="text-xs text-gray-500">1.2 km</span>
                    </div>
                </div>

                <!-- Card Taller 2 -->
                <div class="p-4 bg-gray-700/40 rounded-xl border border-gray-600 hover:border-orange-500/50 transition-colors cursor-pointer group">
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-white group-hover:text-orange-400">MotoServicios Express</h4>
                        <span class="text-xs bg-green-500/20 text-green-300 px-2 py-0.5 rounded-full">Abierto</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Villa Fontana, 1c lago.</p>
                    <div class="mt-3 flex justify-between items-center">
                        <span class="text-xs text-gray-300 font-bold">‚≠ê 4.8</span>
                        <span class="text-xs text-gray-500">2.5 km</span>
                    </div>
                </div>

                 <!-- Card Taller 3 -->
                <div class="p-4 bg-gray-700/40 rounded-xl border border-gray-600 opacity-75">
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-white">Central de Repuestos</h4>
                        <span class="text-xs bg-red-500/20 text-red-300 px-2 py-0.5 rounded-full">Cerrado</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Mercado Huembes.</p>
                </div>
            </div>

            <!-- CONTENIDO TAB 2: VIAJES -->
            <div id="content-trips" class="hidden p-4 overflow-y-auto flex-1 space-y-6">
                
                {% if main_moto %}
                    <div class="flex justify-between items-center text-xs text-gray-400 bg-gray-900/50 p-2 rounded-lg">
                        <span>Moto: <b class="text-white">{{ main_moto.nickname }}</b></span>
                        <span>Total: <b class="text-orange-400">{{ total_km_trips }} km</b></span>
                    </div>

                    {% if trips %}
                    <div class="relative border-l-2 border-gray-600 ml-2 space-y-6">
                        {% for trip in trips %}
                        <div class="relative pl-6">
                            <div class="absolute -left-[9px] top-1 w-4 h-4 rounded-full border-2 border-gray-800
                                {% if trip.terrain == 'city' %} bg-blue-500
                                {% elif trip.terrain == 'highway' %} bg-purple-500
                                {% else %} bg-orange-500 {% endif %}">
                            </div>
                            
                            <div class="p-3 bg-gray-700/30 rounded-lg border border-gray-600">
                                <div class="flex justify-between items-start">
                                    <h4 class="text-sm font-bold text-white">{{ trip.title }}</h4>
                                    <span class="text-[10px] text-gray-400">{{ trip.date|date:"d/m/y" }}</span>
                                </div>
                                <div class="flex gap-3 mt-2 text-xs text-gray-300">
                                    <span class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> {{ trip.distance_km }} km</span>
                                    <span class="opacity-70">{{ trip.get_terrain_display }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                        <div class="text-center py-10 text-gray-500">
                            <p>No hay viajes registrados.</p>
                            <!-- Este bot√≥n solo se muestra si la lista est√° vac√≠a -->
                            <button id="btn-add-trip-empty" class="mt-2 text-orange-400 hover:underline text-sm">Registrar el primero</button>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-10 text-gray-500">
                        <p>Selecciona una moto para ver sus viajes.</p>
                    </div>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<!-- BOT√ìN FLOTANTE (FAB) M√ìVIL -->
<!-- Inicia oculto (hidden). JS lo activar√° solo en la pesta√±a de viajes. sm:hidden asegura que nunca salga en PC -->
<button id="btn-add-trip-fab" class="hidden fixed bottom-24 right-6 z-40 p-4 text-gray-900 bg-orange-500 rounded-full shadow-2xl sm:hidden hover:bg-orange-600 transition-transform hover:scale-110 focus:outline-none border-2 border-orange-400">
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
</button>

<!-- MODAL NUEVO VIAJE -->
<div id="trip-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-80 backdrop-blur-sm">
    <div class="w-full max-w-lg p-6 bg-gray-800 rounded-2xl shadow-2xl border border-gray-700">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-white">Registrar Ruta</h3>
            <button id="close-trip-modal" class="text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        </div>

        <form action="{% url 'map' %}" method="POST" class="space-y-4">
            {% csrf_token %}
            
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">T√≠tulo</label>
                <input type="text" name="title" required placeholder="Ej: Vuelta a la Laguna" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm focus:ring-1 focus:ring-orange-500 focus:outline-none">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Fecha</label>
                    <input type="date" name="date" required value="{% now 'Y-m-d' %}" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm" style="color-scheme: dark;">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Distancia (km)</label>
                    <input type="number" name="distance" required placeholder="120" min="1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm focus:ring-1 focus:ring-orange-500 focus:outline-none">
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Tipo de Terreno</label>
                <select name="terrain" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none">
                    <option value="mixed" selected>Mixto</option>
                    <option value="city">Ciudad</option>
                    <option value="highway">Carretera</option>
                    <option value="offroad">Off-Road</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Notas</label>
                <textarea name="notes" rows="2" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none"></textarea>
            </div>

            <div class="flex items-center gap-2 pt-2">
                <input type="checkbox" name="update_odometer" id="update_odometer" class="w-4 h-4 text-orange-500 bg-gray-700 border-gray-600 rounded focus:ring-orange-500">
                <label for="update_odometer" class="text-xs text-gray-300 cursor-pointer">Sumar al od√≥metro de la moto</label>
            </div>

            <div class="pt-4 flex justify-end gap-3">
                <button type="button" id="cancel-trip-modal" class="px-4 py-2 text-gray-300 hover:text-white bg-gray-700 rounded-lg">Cancelar</button>
                <button type="submit" class="px-6 py-2 bg-orange-500 hover:bg-orange-600 text-white font-bold rounded-lg shadow-lg">Guardar Viaje</button>
            </div>
        </form>
    </div>
</div>

<script>
    // L√≥gica de Pesta√±as
    function switchTab(tab) {
        const contentW = document.getElementById('content-workshops');
        const contentT = document.getElementById('content-trips');
        const btnW = document.getElementById('tab-workshops');
        const btnT = document.getElementById('tab-trips');
        
        const btnAdd = document.getElementById('btn-add-trip-header');
        const btnFab = document.getElementById('btn-add-trip-fab');

        if (tab === 'workshops') {
            // MOSTRAR TALLERES
            contentW.classList.remove('hidden');
            contentT.classList.add('hidden');
            
            // Estilos Tab
            btnW.classList.add('text-orange-400', 'border-b-2', 'border-orange-500', 'bg-gray-700/30');
            btnW.classList.remove('text-gray-400');
            btnT.classList.remove('text-orange-400', 'border-b-2', 'border-orange-500', 'bg-gray-700/30');
            btnT.classList.add('text-gray-400');
            
            // OCULTAR BOTONES DE ACCI√ìN
            // Aseguramos que el bot√≥n de escritorio se oculta
            btnAdd.classList.remove('sm:flex'); 
            btnAdd.classList.add('hidden');     
            
            btnFab.classList.add('hidden'); // Ocultar FAB m√≥vil

        } else {
            // MOSTRAR VIAJES
            contentW.classList.add('hidden');
            contentT.classList.remove('hidden');
            
            // Estilos Tab
            btnT.classList.add('text-orange-400', 'border-b-2', 'border-orange-500', 'bg-gray-700/30');
            btnT.classList.remove('text-gray-400');
            btnW.classList.remove('text-orange-400', 'border-b-2', 'border-orange-500', 'bg-gray-700/30');
            btnW.classList.add('text-gray-400');
            
            // MOSTRAR BOTONES DE ACCI√ìN
            // Escritorio: Mantenemos 'hidden' base y agregamos 'sm:flex' (solo visible en pantallas grandes)
            btnAdd.classList.add('sm:flex'); 
            // M√≥vil: Quitamos 'hidden' (visible en pantallas peque√±as, sm:hidden lo oculta en grandes)
            btnFab.classList.remove('hidden'); 
        }
    }

    // L√≥gica Modal
    const modal = document.getElementById('trip-modal');
    const openBtn1 = document.getElementById('btn-add-trip-header');
    const openBtn2 = document.getElementById('btn-add-trip-empty');
    const openBtnFab = document.getElementById('btn-add-trip-fab');
    const closeBtn = document.getElementById('close-trip-modal');
    const cancelBtn = document.getElementById('cancel-trip-modal');

    const openModal = () => modal.classList.remove('hidden');
    const closeModal = () => modal.classList.add('hidden');

    if(openBtn1) openBtn1.addEventListener('click', openModal);
    if(openBtn2) openBtn2.addEventListener('click', openModal);
    if(openBtnFab) openBtnFab.addEventListener('click', openModal);
    if(closeBtn) closeBtn.addEventListener('click', closeModal);
    if(cancelBtn) cancelBtn.addEventListener('click', closeModal);
    
    // Cerrar si clic fuera del modal
    modal.addEventListener('click', (e) => {
        if(e.target === modal) closeModal();
    });
</script>

{% endblock %}