{% extends "base.html" %}

{% block content %}

{% load moto_extras %}

<div class="p-4 mx-auto max-w-7xl sm:p-6 lg:p-8">
    
    <!-- Header y Buscador -->
    <div class="flex flex-col gap-6 pb-6 mb-6 border-b border-gray-700 md:flex-row md:items-center md:justify-between">
        <div>
            <h2 class="text-3xl font-bold text-white">Mi Garaje</h2>
            <p class="mt-1 text-sm text-gray-400">Gestiona tu flota de vehículos.</p>
        </div>
        
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center w-full md:w-auto">
            
            <!-- BUSCADOR EN TIEMPO REAL -->
            <div class="relative w-full md:w-64">
                <input type="text" id="search-input" onkeyup="filterGarageRealTime()" 
                       placeholder="Buscar por placa, apodo..." 
                       class="w-full pl-10 pr-4 py-2 text-sm text-white bg-gray-800 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 transition-all placeholder-gray-500">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>

            <!-- DROPDOWN DE FILTRO -->
            <div class="relative text-left">
                <button type="button" onclick="toggleFilterMenu()" id="filter-menu-button" 
                    class="inline-flex items-center justify-center w-full px-4 py-2 text-sm font-medium text-gray-300 bg-gray-800 border border-gray-600 rounded-lg shadow-sm hover:bg-gray-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-orange-500 transition-colors">
                    <svg class="w-5 h-5 mr-2 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                    <span id="current-filter-label">Activas</span>
                    <svg class="w-5 h-5 ml-2 -mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>

                <!-- Menú desplegable -->
                <div id="filter-dropdown" class="absolute right-0 z-10 hidden w-40 mt-2 origin-top-right bg-gray-800 border border-gray-700 rounded-md shadow-xl ring-1 ring-black ring-opacity-5 focus:outline-none animate-fade-in-down">
                    <div class="py-1" role="none">
                        <button onclick="filterGarage('active')" id="btn-active" class="filter-option block w-full px-4 py-2 text-sm text-left text-orange-400 bg-gray-700/50 font-bold" role="menuitem">Activas</button>
                        <button onclick="filterGarage('inactive')" id="btn-inactive" class="filter-option block w-full px-4 py-2 text-sm text-left text-gray-300 hover:bg-gray-700 hover:text-white" role="menuitem">Inactivas</button>
                        <button onclick="filterGarage('all')" id="btn-all" class="filter-option block w-full px-4 py-2 text-sm text-left text-gray-300 hover:bg-gray-700 hover:text-white" role="menuitem">Todas</button>
                    </div>
                </div>
            </div>

            <!-- Botón Agregar (Escritorio) -->
            <a href="{% url 'motoadd' %}" class="hidden sm:flex items-center justify-center gap-2 px-4 py-2 text-sm font-bold text-gray-900 bg-orange-500 rounded-lg hover:bg-orange-600 transition-colors shadow-lg shadow-orange-500/20 whitespace-nowrap">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                <span>Nueva Moto</span>
            </a>
        </div>
    </div>

    <!-- 
        MOTORCYCLE GRID
    -->
    {% if motorcycles_data %}
    <div id="moto-grid" class="grid grid-cols-1 gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 transition-all duration-500">
        {% for item in motorcycles_data %}
        {% with motorcycle=item.obj %}
        
        <!-- Motorcycle Card -->
        <!-- Agregamos data-attributes para el buscador JS -->
        <a href="{% url 'motodetails' moto_id=motorcycle.id %}" 
           class="moto-card group relative block h-full no-underline transition-all duration-300 transform scale-100 opacity-100"
           data-search="{{ motorcycle.nickname|lower }} {{ motorcycle.model|model_desc|lower }} {{ motorcycle.plate_number|lower }} {{ motorcycle.make|lower }}"
           data-status="{% if motorcycle.is_active %}active{% else %}inactive{% endif %}">
           
            <div class="flex flex-col h-full overflow-hidden bg-gray-800 border border-gray-700 rounded-xl 
                 {% if not motorcycle.is_active %} opacity-75 grayscale hover:grayscale-0 hover:opacity-100 {% endif %}
                 hover:border-orange-500/50 hover:shadow-xl hover:-translate-y-1 transition-all">
                
                <!-- Image Container -->
                <div class="relative h-48 overflow-hidden bg-gray-900">
                    {% if motorcycle.photo %}
                        <img src="{{ motorcycle.photo.url }}" 
                             alt="{{ motorcycle.model|model_desc }}"
                             class="object-cover w-full h-full transition-transform duration-500 group-hover:scale-110">
                    {% else %}
                        <img src="https://placehold.co/400x300/1f2937/4b5563?text=Moto" 
                             class="object-cover w-full h-full opacity-50">
                    {% endif %}

                    <!-- SEMÁFORO DE SALUD (NUEVO) -->
                    {% if motorcycle.is_active %}
                    <div class="absolute top-2 right-2 flex items-center gap-1.5 px-2 py-1 bg-gray-900/80 backdrop-blur-md rounded-full border border-gray-700 shadow-lg z-10">
                        <span class="relative flex h-3 w-3">
                          {% if item.health_color == 'red' %}
                             <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                             <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                          {% elif item.health_color == 'yellow' %}
                             <span class="relative inline-flex rounded-full h-3 w-3 bg-yellow-500"></span>
                          {% elif item.health_color == 'green' %}
                             <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                          {% else %}
                             <span class="relative inline-flex rounded-full h-3 w-3 bg-gray-500"></span>
                          {% endif %}
                        </span>
                        <span class="text-[10px] font-bold text-gray-300 uppercase">
                            {% if item.health_color == 'red' %}CRÍTICO
                            {% elif item.health_color == 'yellow' %}ATENCIÓN
                            {% elif item.health_color == 'green' %}OPTIMO
                            {% else %}---{% endif %}
                        </span>
                    </div>
                    {% else %}
                    <!-- Status Badge Inactiva -->
                    <div class="absolute top-0 right-0 px-2 py-1 m-2 text-xs font-bold rounded-md backdrop-blur-md border shadow-sm bg-gray-800/80 text-gray-300 border-gray-600">
                        Inactiva
                    </div>
                    {% endif %}
                    
                    <!-- Gradient Overlay -->
                    <div class="absolute inset-0 bg-gradient-to-t from-gray-900/90 via-transparent to-transparent pointer-events-none"></div>
                </div>

                <!-- Content -->
                <div class="flex flex-col flex-1 p-4 relative">
                    <div class="flex items-start justify-between">
                        <div class="min-w-0">
                            <p class="text-xs font-medium tracking-wider text-orange-400 uppercase truncate">{{ motorcycle.make }}</p>
                            <h4 class="mt-1 text-lg font-bold text-white truncate group-hover:text-orange-100">{{ motorcycle.model|model_desc }}</h4>
                        </div>
                    </div>
                    
                    {% if motorcycle.nickname %}
                        <p class="mt-1 text-sm text-gray-400 italic truncate">"{{ motorcycle.nickname }}"</p>
                    {% else %}
                        <p class="mt-1 text-sm text-gray-400">{{ motorcycle.year }}</p>
                    {% endif %}

                    <div class="mt-auto pt-4 border-t border-gray-700/50 space-y-2">
                        <div class="flex items-center gap-2 text-sm text-gray-500">
                            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            <span class="font-mono">{{ motorcycle.mileage }} km</span>
                        </div>
                        {% if motorcycle.plate_number %}
                        <div class="flex items-center gap-2 text-sm text-gray-500">
                            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 9h3.75M15 12h3.75M15 15h3.75M4.5 19.5h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5zm6-10.125a1.875 1.875 0 11-3.75 0 1.875 1.875 0 013.75 0zm1.294 6.336a6.721 6.721 0 01-3.17.789 6.721 6.721 0 01-3.168-.789 3.376 3.376 0 016.338 0z"></path></svg>
                            <span class="font-mono bg-gray-900 px-1.5 py-0.5 rounded text-xs border border-gray-700 text-gray-300 tracking-wide">{{ motorcycle.plate_number|plate_format }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </a>
        {% endwith %}
        {% endfor %}
    </div>

    {% else %}
    <!-- EMPTY STATE -->
    <div class="flex flex-col items-center justify-center py-20 mt-8 text-center bg-gray-800/50 border-2 border-dashed border-gray-700 rounded-2xl">
        <div class="p-4 mb-4 bg-gray-800 rounded-full">
            <svg class="w-12 h-12 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
        </div>
        <h3 class="text-xl font-bold text-white">Tu garaje está vacío</h3>
        <p class="max-w-md mx-auto mt-2 text-gray-400">Registra tu primera motocicleta para comenzar.</p>
        <a href="{% url 'motoadd' %}" class="flex items-center justify-center gap-2 px-6 py-3 mt-8 text-base font-bold text-white transition-all duration-200 bg-orange-500 rounded-lg hover:bg-orange-600 shadow-lg shadow-orange-500/20">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            <span>Agregar Moto</span>
        </a>
    </div>
    {% endif %}

    <!-- EMPTY STATE OCULTO (Para filtros JS) -->
    <div id="empty-state-js" class="hidden flex-col items-center justify-center py-20 mt-8 text-center bg-gray-800/50 border-2 border-dashed border-gray-700 rounded-2xl animate-fade-in">
        <div class="p-4 mb-4 bg-gray-800 rounded-full">
            <svg class="w-12 h-12 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
        </div>
        <h3 id="empty-title-js" class="text-xl font-bold text-white">No se encontraron motos</h3>
        <p id="empty-desc-js" class="max-w-md mx-auto mt-2 text-gray-400">Intenta cambiar los filtros de búsqueda.</p>
    </div>

</div>

<!-- BOTÓN FLOTANTE (FAB) PARA AGREGAR MOTO (MÓVIL) -->
<!-- Se muestra solo en 'sm' o menor (hidden en sm:hidden) -->
<a href="{% url 'motoadd' %}" class="fixed bottom-24 right-6 z-40 p-4 text-gray-900 bg-orange-500 rounded-full shadow-2xl sm:hidden hover:bg-orange-600 transition-transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 active:scale-95 border-2 border-orange-400">
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
</a>

<style>
    /* Animación simple para el dropdown */
    @keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-down {
        animation: fadeInDown 0.2s ease-out;
    }
</style>

<script>
    // --- LÓGICA DE BÚSQUEDA Y FILTRO ---

    function toggleFilterMenu() {
        const menu = document.getElementById('filter-dropdown');
        menu.classList.toggle('hidden');
    }

    document.addEventListener('click', function(event) {
        const menu = document.getElementById('filter-dropdown');
        const button = document.getElementById('filter-menu-button');
        if (menu && button && !button.contains(event.target) && !menu.contains(event.target)) {
            menu.classList.add('hidden');
        }
    });

    function filterGarageRealTime() {
        const input = document.getElementById('search-input');
        const searchTerm = input.value.toLowerCase();
        
        // Obtenemos el filtro de estado actual desde la etiqueta del botón (hack rápido visual) o variable global
        // Para simplificar, si buscas, buscamos en TODO. Si limpias, respetamos el estado activo/inactivo por defecto
        
        const cards = document.querySelectorAll('.moto-card');
        let visibleCount = 0;
        
        cards.forEach(card => {
            const searchData = card.getAttribute('data-search') || "";
            // Buscar en todos los datos
            if (searchData.includes(searchTerm)) {
                card.classList.remove('hidden');
                // Pequeño truco para reiniciar la animación
                requestAnimationFrame(() => {
                    card.classList.remove('opacity-0', 'scale-95');
                    card.classList.add('opacity-100', 'scale-100');
                });
                visibleCount++;
            } else {
                card.classList.add('opacity-0', 'scale-95');
                // Ocultamos después de la transición (simulado aquí directo para respuesta rápida)
                card.classList.add('hidden');
                card.classList.remove('opacity-100', 'scale-100');
            }
        });

        // Mostrar estado vacío si no hay resultados
        const emptyState = document.getElementById('empty-state-js');
        if (visibleCount === 0) {
            emptyState.classList.remove('hidden');
            document.getElementById('empty-title-js').innerText = "No se encontraron resultados";
            document.getElementById('empty-desc-js').innerText = `No hay motos que coincidan con "${input.value}"`;
        } else {
            emptyState.classList.add('hidden');
        }
    }

    function filterGarage(filterType) {
        const cards = document.querySelectorAll('.moto-card');
        const emptyState = document.getElementById('empty-state-js');
        const title = document.getElementById('empty-title-js');
        const desc = document.getElementById('empty-desc-js');
        const labelBtn = document.getElementById('current-filter-label');
        
        // Cerrar menú
        document.getElementById('filter-dropdown').classList.add('hidden');
        // Limpiar buscador para no confundir
        document.getElementById('search-input').value = "";

        let visibleCount = 0;

        // Actualizar Texto del Botón
        if (filterType === 'active') labelBtn.innerText = "Activas";
        else if (filterType === 'inactive') labelBtn.innerText = "Inactivas";
        else labelBtn.innerText = "Todas";

        cards.forEach(card => {
            const status = card.getAttribute('data-status');
            
            if (filterType === 'all' || status === filterType) {
                card.classList.remove('hidden');
                requestAnimationFrame(() => {
                    card.classList.remove('opacity-0', 'scale-95');
                    card.classList.add('opacity-100', 'scale-100');
                });
                visibleCount++;
            } else {
                card.classList.add('opacity-0', 'scale-95');
                card.classList.add('hidden');
                card.classList.remove('opacity-100', 'scale-100');
            }
        });

        // Actualizar Estilo de Opciones
        document.querySelectorAll('.filter-option').forEach(btn => {
            btn.className = "filter-option block w-full px-4 py-2 text-sm text-left text-gray-300 hover:bg-gray-700 hover:text-white";
            if (btn.id === 'btn-' + filterType) {
                btn.className = "filter-option block w-full px-4 py-2 text-sm text-left text-orange-400 bg-gray-700/50 font-bold";
            }
        });

        // Estado Vacío Contextual
        if (visibleCount === 0) {
            emptyState.classList.remove('hidden');
            if (filterType === 'active') {
                title.innerText = "No tienes motos activas";
                desc.innerText = "Registra una nueva moto para verla aquí.";
            } else if (filterType === 'inactive') {
                title.innerText = "No tienes motos inactivas";
                desc.innerText = "Las motos que desactives aparecerán aquí.";
            }
        } else {
            emptyState.classList.add('hidden');
        }
    }

    // Inicializar filtro 'active' al cargar la página
    document.addEventListener('DOMContentLoaded', () => {
        // Leemos el filtro inicial que viene del backend
        const initialFilter = "{{ current_filter|default:'active' }}"; 
        filterGarage(initialFilter);
    });
</script>

{% endblock %}